steps:



- id: 'build account'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=account', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/account',
    '--cache-from=gcr.io/$PROJECT_ID/account:latest',
    'app/protobufs/account/.',
  ]
- id: 'build signin'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=signin', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/signin',
    '--cache-from=gcr.io/$PROJECT_ID/signin:latest',
    'app/protobufs/signin/.',
  ]
  waitFor: ['-'] # start immediately

- id: 'build api-gateway'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=api_gateway', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/api-gateway',
    '--cache-from=gcr.io/$PROJECT_ID/api-gateway:latest',
    'app/protobufs/api_gateway/.',
  ]
  waitFor: ['-'] # start immediately
- id: 'build book'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=book', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/book',
    '--cache-from=gcr.io/$PROJECT_ID/book:latest',
    'app/protobufs/book/.',
  ]
  waitFor: ['-'] # start immediately
- id: 'build anime'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=anime', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/anime',
    '--cache-from=gcr.io/$PROJECT_ID/anime:latest',
    'app/protobufs/anime/.',
  ]
  waitFor: ['-'] # start immediately
- id: 'build imdb'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=imdb', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/imdb',
    '--cache-from=gcr.io/$PROJECT_ID/imdb:latest',
    'app/protobufs/imdb/.',
  ]
  waitFor: ['-'] # start immediately
- id: 'build library'
  name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--tag=library', # use local registry for compatibility with local builds
    '--tag=gcr.io/$PROJECT_ID/library',
    '--cache-from=gcr.io/$PROJECT_ID/library:latest',
    'app/protobufs/library/.',
  ]
  waitFor: ['-'] # start immediately

#- id: 'dns up'
#  name: 'gcr.io/cloud-builders/docker'
#  args: [
#      'run', 'defreitas/dns-proxy-server',
#
#  ]
#  waitFor: ['-']


- id: 'compose up'
  name: 'gcr.io/$PROJECT_ID/docker-compose:latest'
  entrypoint: '/bin/bash'
  args:
  - '-c'
  - |
    docker-compose up -d --force-recreate --build
  env:
  - 'PROJECT_ID=$PROJECT_ID'
  waitFor: ['build account','build signin','build api-gateway','build book','build anime','build imdb','build library']


- id: 'integration tests'
  name: 'gcr.io/$PROJECT_ID/docker-compose:latest'
  entrypoint: '/bin/bash'
  args:
    - '-c'
    - |
      docker container ls -a
      sleep 10
      ./app/protobufs/api_gateway/api_gateway_test.sh -r 20 -i 3 -u https://api-gateway:5000
  env:
    - 'PROJECT_ID=$PROJECT_ID'
  waitFor: ['compose up']

- id: 'pushing imdb'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/imdb"]
  waitFor: [ 'integration tests' ]


  # deploy container image to GKE
- id: 'deploy image imdb'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/imdb
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing imdb' ]

- id: 'pushing account'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/account"]
  waitFor: [ 'deploy image imdb' ]


  # deploy container image to GKE
- id: 'deploy image account'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/account
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing account' ]

- id: 'pushing signin'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/signin"]
  waitFor: [ 'deploy image account' ]


  # deploy container image to GKE
- id: 'deploy image signin'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/signin
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing signin' ]

- id: 'pushing api-gateway'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/api-gateway"]
  waitFor: [ 'deploy image signin' ]


  # deploy container image to GKE
- id: 'deploy image api-gateway'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/api-gateway
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing api-gateway' ]

- id: 'pushing book'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/book"]
  waitFor: [ 'deploy image api-gateway' ]


  # deploy container image to GKE
- id: 'deploy image book'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/book
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing book' ]

- id: 'pushing anime'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/anime"]
  waitFor: [ 'deploy image book' ]


  # deploy container image to GKE
- id: 'deploy image anime'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/anime
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing anime' ]

- id: 'pushing library'
  name: "gcr.io/cloud-builders/docker"
  args: ["push", "gcr.io/$PROJECT_ID/library"]
  waitFor: [ 'deploy image anime' ]


  # deploy container image to GKE
- id: 'deploy image library'
  name: "gcr.io/cloud-builders/gke-deploy"
  args:
  - run
  - --filename=deployment.yaml
  - --image=gcr.io/$PROJECT_ID/library
  - --location=${_CLOUDSDK_COMPUTE_ZONE}
  - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}
  waitFor: [ 'pushing library' ]

images:
- gcr.io/$PROJECT_ID/imdb
- gcr.io/$PROJECT_ID/account
- gcr.io/$PROJECT_ID/signin
- gcr.io/$PROJECT_ID/api-gateway
- gcr.io/$PROJECT_ID/book
- gcr.io/$PROJECT_ID/anime
- gcr.io/$PROJECT_ID/library